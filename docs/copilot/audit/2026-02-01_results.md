# Codebase Audit Report

## Audit Metadata

- **Audit Date**: 2026-02-01 16:51:32 UTC
- **Scope**: full (all checks with IIS deployment focus)
- **Auditor**: speckit.site-audit
- **Constitution Version**: 1.1.0
- **Repository**: SupportSpark
- **Target Platform**: Windows 11 + IIS 10.0+

## Executive Summary

### Compliance Score

| Category                 | Score | Status     |
| ------------------------ | ----- | ---------- |
| Constitution Compliance  | 38%   | ‚ùå FAIL    |
| Security                 | 25%   | ‚ùå FAIL    |
| Code Quality             | 65%   | ‚ö†Ô∏è PARTIAL |
| Test Coverage            | 0%    | ‚ùå FAIL    |
| Documentation            | 85%   | ‚úÖ PASS    |
| Dependencies             | 90%   | ‚úÖ PASS    |
| IIS Deployment Readiness | 70%   | ‚ö†Ô∏è PARTIAL |

**Overall Health**: üî¥ CRITICAL ISSUES - Immediate attention required before production deployment

### Issue Summary

| Severity    | Count |
| ----------- | ----- |
| üî¥ CRITICAL | 6     |
| üü† HIGH     | 7     |
| üü° MEDIUM   | 8     |
| üîµ LOW      | 3     |

**Total Issues**: 24

---

## Constitution Compliance

### Principle Compliance Matrix

| Principle                  | Status     | Violations | Key Issues                                                |
| -------------------------- | ---------- | ---------- | --------------------------------------------------------- |
| I. Type Safety             | ‚ö†Ô∏è PARTIAL | 8          | Multiple `any` types without justification                |
| II. Testing                | ‚ùå FAIL    | 1          | Zero test files - no automated tests exist                |
| III. UI Components         | ‚úÖ PASS    | 0          | shadcn/ui properly used throughout                        |
| IV. Security Standards     | ‚ùå FAIL    | 4          | Passwords not hashed, no rate limiting, hardcoded secrets |
| V. API Contract Pattern    | ‚úÖ PASS    | 0          | All routes properly defined in shared/routes.ts           |
| VI. State Management       | ‚úÖ PASS    | 0          | React Query properly implemented                          |
| VII. Code Style            | ‚ùå FAIL    | 2          | No ESLint/Prettier configuration                          |
| VIII. Deployment & Hosting | ‚ö†Ô∏è PARTIAL | 3          | IIS configuration present but incomplete setup            |

---

## Security Findings

### Vulnerability Summary

| Type                     | Count | Severity |
| ------------------------ | ----- | -------- |
| Plain Text Passwords     | 1     | CRITICAL |
| Hardcoded Secrets        | 1     | CRITICAL |
| Missing Rate Limiting    | 1     | CRITICAL |
| Missing Input Validation | 2     | HIGH     |
| Insecure File Upload     | 1     | MEDIUM   |

### Security Checklist

- [x] No hardcoded API keys or tokens
- [ ] **Passwords hashed with bcrypt** ‚ùå
- [x] SQL injection protection (not using SQL)
- [ ] **Rate limiting on authentication endpoints** ‚ùå
- [ ] **Session secrets from environment only** ‚ùå
- [x] Dependencies free of known vulnerabilities
- [x] CSRF protection via same-origin policy
- [ ] Input validation at API boundary (partial)

### Detailed Security Issues

#### SEC1: Plain Text Password Storage and Comparison (CRITICAL)

**Principle Violated**: IV. Security Standards

> "User passwords MUST be hashed using bcrypt (minimum 10 rounds)"

**Location**: [server/routes.ts](server/routes.ts#L47-L48)

```typescript
// Simple password check (in real app, use bcrypt)
if (user.password !== password) {
  return done(null, false, { message: "Incorrect password." });
}
```

**Impact**: User passwords stored in plain text in data/users.json. Complete compromise of all user credentials if data directory is exposed.

**Evidence**: [shared/schema.ts](shared/schema.ts#L7)

```typescript
password: z.string(), // Hashed in a real app, keeping simple for now
```

**Recommendation**:

1. Install bcrypt: `npm install bcrypt @types/bcrypt`
2. Update [server/routes.ts](server/routes.ts#L93):

```typescript
import bcrypt from "bcrypt";

// On registration
const hashedPassword = await bcrypt.hash(req.body.password, 10);

// On login
if (!(await bcrypt.compare(password, user.password))) {
  return done(null, false, { message: "Incorrect password." });
}
```

3. Migrate existing user passwords (requires re-registration or password reset)

---

#### SEC2: Hardcoded Session Secret Fallback (CRITICAL)

**Principle Violated**: IV. Security Standards

> "Session secrets MUST be provided via environment variables (never hardcoded)"

**Location**: [server/routes.ts](server/routes.ts#L23)

```typescript
const sessionSecret = process.env.SESSION_SECRET || "simple-secret-key";
```

**Impact**: If SESSION_SECRET is not set in production, predictable session secret enables session hijacking and forgery attacks.

**Recommendation**:

1. Remove fallback value - fail fast if not configured:

```typescript
const sessionSecret = process.env.SESSION_SECRET;
if (!sessionSecret) {
  throw new Error("SESSION_SECRET environment variable is required");
}
```

2. For IIS deployment, set in web.config or IIS Configuration Editor:

```xml
<configuration>
  <system.webServer>
    <iisnode>
      <environmentVariables>
        <add name="SESSION_SECRET" value="generate-strong-random-value" />
      </environmentVariables>
    </iisnode>
  </system.webServer>
</configuration>
```

3. Generate strong secret: `node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"`

---

#### SEC3: Missing Rate Limiting on Authentication Routes (CRITICAL)

**Principle Violated**: IV. Security Standards

> "Authentication endpoints MUST implement rate limiting"

**Location**: [server/routes.ts](server/routes.ts#L80-L116) (login, register, demo routes)

**Impact**: Allows brute-force password attacks, account enumeration, and denial-of-service.

**Recommendation**:

1. Install rate limiter: `npm install express-rate-limit`
2. Add to [server/routes.ts](server/routes.ts#L20):

```typescript
import rateLimit from 'express-rate-limit';

const authLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 5, // 5 attempts per window
  message: { message: "Too many login attempts, please try again later" },
  standardHeaders: true,
  legacyHeaders: false,
});

// Apply to auth routes
app.post("/api/login", authLimiter, passport.authenticate("local"), ...);
app.post("/api/register", authLimiter, async (req, res) => {...});
```

---

#### SEC4: File Upload Path Traversal Risk (MEDIUM)

**Principle Violated**: IV. Security Standards

> "File uploads MUST validate file types and enforce size limits"

**Location**: [server/routes.ts](server/routes.ts#L438-L452)

**Issue**: Filename sanitization relies solely on multer's random suffix. Original filename not sanitized for path traversal sequences.

**Current Implementation**:

```typescript
filename: (_req, file, cb) => {
  const uniqueSuffix = Date.now() + "-" + Math.round(Math.random() * 1e9);
  const ext = path.extname(file.originalname);
  cb(null, `${uniqueSuffix}${ext}`);
};
```

**Recommendation**: Add explicit sanitization:

```typescript
import path from "path";

const sanitizeFilename = (originalname: string): string => {
  return path.basename(originalname).replace(/[^\w.-]/g, "_");
};

filename: (_req, file, cb) => {
  const safeName = sanitizeFilename(file.originalname);
  const ext = path.extname(safeName);
  const uniqueSuffix = Date.now() + "-" + Math.round(Math.random() * 1e9);
  cb(null, `${uniqueSuffix}${ext}`);
};
```

---

#### SEC5: Insufficient Input Validation on API Routes (HIGH)

**Principle Violated**: IV. Security Standards

**Locations**:

- [server/routes.ts](server/routes.ts#L131) - `/api/conversations/list` - No query param validation
- [server/routes.ts](server/routes.ts#L189) - `/api/conversations/:id/messages` - Content length not validated

**Recommendation**: Add Zod validation for all request bodies and query parameters at API boundaries.

---

## Type Safety Analysis

### Principle I Compliance

**Constitution Requirement**:

> "All code MUST maintain strict type safety through TypeScript and runtime validation"
> "No `any` types without explicit justification in code comments"

### Type Safety Violations

| ID     | File:Line                                                                                                  | Issue                                                 | Justification Present? |
| ------ | ---------------------------------------------------------------------------------------------------------- | ----------------------------------------------------- | ---------------------- |
| TYPE1  | [shared/routes.ts](shared/routes.ts#L32)                                                                   | `z.custom<any>()` for conversation responses          | ‚ùå No                  |
| TYPE2  | [shared/routes.ts](shared/routes.ts#L75)                                                                   | `z.custom<any>()` for supporter list                  | ‚ùå No                  |
| TYPE3  | [server/storage.ts](server/storage.ts#L15)                                                                 | `initialMessage: any` parameter                       | ‚ùå No                  |
| TYPE4  | [server/storage.ts](server/storage.ts#L418)                                                                | `initialMessage: any` implementation                  | ‚ùå No                  |
| TYPE5  | [server/routes.ts](server/routes.ts#L58)                                                                   | `passport.serializeUser((user: any, done)`            | ‚ùå No                  |
| TYPE6  | [server/routes.ts](server/routes.ts#L74)                                                                   | `sanitizeUser = (user: any)`                          | ‚ùå No                  |
| TYPE7  | [server/routes.ts](server/routes.ts#L122)                                                                  | `requireAuth = (req: any, res: any, next: any)`       | ‚ùå No                  |
| TYPE8  | [server/routes.ts](server/routes.ts#L131-304)                                                              | 12 route handlers use `(req: any, res)`               | ‚ùå No                  |
| TYPE9  | [client/src/pages/Dashboard.tsx](client/src/pages/Dashboard.tsx#L115)                                      | `UpdateCard({ conversation }: { conversation: any })` | ‚ùå No                  |
| TYPE10 | [client/src/pages/Auth.tsx](client/src/pages/Auth.tsx#L49)                                                 | `onSubmit: (data: any)`                               | ‚ùå No                  |
| TYPE11 | [client/src/components/invite-supporter-dialog.tsx](client/src/components/invite-supporter-dialog.tsx#L50) | `catch (error: any)`                                  | ‚ö†Ô∏è Common pattern      |
| TYPE12 | [client/src/components/create-update-dialog.tsx](client/src/components/create-update-dialog.tsx#L245)      | `(textareaRef as any).current = e`                    | ‚ùå No                  |

**Severity**: HIGH

**Recommendations**:

1. **TYPE1 & TYPE2** - Replace `z.custom<any>()` with proper Zod schemas:

```typescript
// In shared/routes.ts
import { conversationSchema, supporterSchema } from "@shared/schema";

export const api = {
  conversations: {
    list: {
      method: "GET" as const,
      path: "/api/conversations",
      responses: {
        200: z.array(conversationSchema),
      },
    },
  },
  supporters: {
    list: {
      method: "GET" as const,
      path: "/api/supporters",
      responses: {
        200: z.object({
          mySupporters: z.array(supporterSchema),
          supporting: z.array(supporterSchema),
        }),
      },
    },
  },
};
```

2. **TYPE3 & TYPE4** - Define proper Message type in [server/storage.ts](server/storage.ts#L15):

```typescript
import { type Message } from "@shared/schema";

export interface IStorage {
  createConversation(
    memberId: string,
    title: string,
    initialMessage: Message
  ): Promise<Conversation>;
}
```

3. **TYPE5-TYPE8** - Create proper Express types with user context:

```typescript
// In server/types.ts (new file)
import { type User } from "@shared/schema";
import { type Request, type Response, type NextFunction } from "express";

export interface AuthenticatedRequest extends Request {
  user: User;
}

export type AuthMiddleware = (req: Request, res: Response, next: NextFunction) => void;
export type AuthHandler = (req: AuthenticatedRequest, res: Response) => Promise<void>;

// In server/routes.ts
import { type AuthenticatedRequest, type AuthMiddleware, type AuthHandler } from "./types";

const requireAuth: AuthMiddleware = (req, res, next) => {
  if (!req.isAuthenticated()) {
    return res.status(401).json({ message: "Unauthorized" });
  }
  next();
};

const listConversations: AuthHandler = async (req, res) => {
  const conversations = await storage.getConversationsForUser(req.user.id);
  res.json(conversations);
};

app.get(api.conversations.list.path, requireAuth, listConversations);
```

4. **TYPE9 & TYPE10** - Import proper types from schema:

```typescript
// In client/src/pages/Dashboard.tsx
import { type Conversation } from "@shared/schema";

function UpdateCard({ conversation, isMine }: { conversation: Conversation; isMine?: boolean }) {
  // ...
}
```

5. **TYPE11** - Acceptable for error handling, but can improve:

```typescript
catch (error) {
  const message = error instanceof Error ? error.message : "Unknown error";
  // handle error
}
```

---

## Testing Analysis

### Principle II Compliance

**Constitution Requirement**:

> "All new features MUST have accompanying test files before merge"
> "Test files MUST be named `*.test.ts` or `*.test.tsx`"
> "Test framework: Vitest (preferred) or Jest"

### Test Coverage Summary

| Category         | Files | With Tests | Coverage |
| ---------------- | ----- | ---------- | -------- |
| Server Routes    | 1     | 0          | 0%       |
| Storage Layer    | 1     | 0          | 0%       |
| API Contracts    | 1     | 0          | 0%       |
| React Hooks      | 4     | 0          | 0%       |
| React Components | 11    | 0          | 0%       |
| React Pages      | 6     | 0          | 0%       |

**Total Test Files**: 0
**Total Source Files**: 78
**Test Coverage**: 0%

**Severity**: CRITICAL

### Missing Test Infrastructure

| ID    | Item                  | Status     | Priority |
| ----- | --------------------- | ---------- | -------- |
| TEST1 | Vitest configuration  | ‚ùå Missing | CRITICAL |
| TEST2 | Test setup files      | ‚ùå Missing | CRITICAL |
| TEST3 | Mock utilities        | ‚ùå Missing | HIGH     |
| TEST4 | API integration tests | ‚ùå Missing | CRITICAL |
| TEST5 | Component unit tests  | ‚ùå Missing | HIGH     |

### Recommended Test Coverage (Priority Order)

#### CRITICAL Priority - Must Implement Before Production

1. **Authentication Flow Tests** (`server/routes.test.ts`)

```typescript
import { describe, it, expect, beforeEach } from "vitest";
import request from "supertest";
import { app } from "./index";

describe("Authentication", () => {
  it("should reject login with incorrect password", async () => {
    const response = await request(app)
      .post("/api/login")
      .send({ email: "test@example.com", password: "wrong" });
    expect(response.status).toBe(401);
  });

  it("should accept login with correct credentials", async () => {
    // Register first
    await request(app)
      .post("/api/register")
      .send({ email: "test@example.com", password: "password123", firstName: "Test" });

    // Then login
    const response = await request(app)
      .post("/api/login")
      .send({ email: "test@example.com", password: "password123" });
    expect(response.status).toBe(200);
    expect(response.body.email).toBe("test@example.com");
  });
});
```

2. **Storage Layer Tests** (`server/storage.test.ts`)
3. **API Contract Validation Tests** (`shared/routes.test.ts`)

#### HIGH Priority - Implement This Sprint

4. **React Hook Tests** (`client/src/hooks/use-auth.test.ts`, `use-conversations.test.ts`)
5. **Critical Component Tests** (Auth.tsx, Dashboard.tsx, ConversationView.tsx)

### Setup Vitest

Create `vitest.config.ts`:

```typescript
import { defineConfig } from "vitest/config";
import react from "@vitejs/plugin-react";
import path from "path";

export default defineConfig({
  plugins: [react()],
  test: {
    environment: "jsdom",
    globals: true,
    setupFiles: ["./test/setup.ts"],
  },
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "./client/src"),
      "@shared": path.resolve(__dirname, "./shared"),
    },
  },
});
```

Install dependencies:

```bash
npm install -D vitest @vitest/ui jsdom @testing-library/react @testing-library/jest-dom @testing-library/user-event supertest @types/supertest
```

---

## Code Style & Formatting

### Principle VII Compliance

**Constitution Requirement**:

> "ESLint MUST be configured with TypeScript and React rules"
> "Prettier MUST be configured for consistent formatting"
> "All code MUST pass linting before merge"

### Linting Configuration Status

| Tool             | Status            | Severity |
| ---------------- | ----------------- | -------- |
| ESLint           | ‚ùå Not Configured | CRITICAL |
| Prettier         | ‚ùå Not Configured | CRITICAL |
| Pre-commit Hooks | ‚ùå Not Configured | HIGH     |

**Severity**: CRITICAL

### Recommendation: Configure Linting

**STYLE1**: Create `.eslintrc.json`:

```json
{
  "extends": [
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended",
    "plugin:react/recommended",
    "plugin:react-hooks/recommended",
    "prettier"
  ],
  "parser": "@typescript-eslint/parser",
  "parserOptions": {
    "ecmaVersion": 2022,
    "sourceType": "module",
    "project": "./tsconfig.json"
  },
  "plugins": ["@typescript-eslint", "react", "react-hooks"],
  "rules": {
    "@typescript-eslint/no-explicit-any": "error",
    "@typescript-eslint/explicit-function-return-type": "off",
    "react/react-in-jsx-scope": "off",
    "react/prop-types": "off"
  },
  "settings": {
    "react": {
      "version": "detect"
    }
  }
}
```

**STYLE2**: Create `.prettierrc.json`:

```json
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": false,
  "printWidth": 100,
  "tabWidth": 2,
  "useTabs": false
}
```

**STYLE3**: Install dependencies:

```bash
npm install -D eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin eslint-plugin-react eslint-plugin-react-hooks eslint-config-prettier prettier
```

**STYLE4**: Add scripts to package.json:

```json
{
  "scripts": {
    "lint": "eslint . --ext .ts,.tsx --max-warnings 0",
    "lint:fix": "eslint . --ext .ts,.tsx --fix",
    "format": "prettier --write \"**/*.{ts,tsx,js,json,md}\""
  }
}
```

**STYLE5**: Configure pre-commit hooks with Husky (optional but recommended):

```bash
npm install -D husky lint-staged
npx husky install
npx husky add .husky/pre-commit "npx lint-staged"
```

Add to package.json:

```json
{
  "lint-staged": {
    "*.{ts,tsx}": ["eslint --fix", "prettier --write"],
    "*.{json,md}": ["prettier --write"]
  }
}
```

---

## IIS Deployment Analysis

### Principle VIII Compliance

**Constitution Requirement**:

> "The application MUST be deployable to Windows 11 with IIS for production hosting"

### IIS Deployment Checklist

| Requirement                  | Status     | Notes                                               |
| ---------------------------- | ---------- | --------------------------------------------------- |
| web.config present           | ‚úÖ PASS    | Comprehensive configuration exists                  |
| Build outputs CommonJS       | ‚úÖ PASS    | `dist/index.cjs` format correct                     |
| Static files in public/      | ‚úÖ PASS    | Build places files in `dist/public/`                |
| URL rewrite rules            | ‚úÖ PASS    | API, static, SPA routing configured                 |
| iisnode configuration        | ‚úÖ PASS    | Production settings present                         |
| Environment variable support | ‚ö†Ô∏è PARTIAL | Template provided but SESSION_SECRET not documented |
| Data directory setup         | ‚ùå MISSING | No automated setup for IIS_IUSRS permissions        |
| Production storage           | ‚ùå MISSING | Still using file-based JSON storage                 |
| SSL/TLS configuration        | ‚ö†Ô∏è N/A     | IIS-level configuration (not code)                  |

### IIS Deployment Issues

#### DEPLOY1: Missing Data Directory Permissions Setup (HIGH)

**Principle Violated**: VIII. Deployment & Hosting Standards

> "Data directory MUST have write permissions for `IIS_IUSRS` group"

**Location**: Build process and deployment scripts

**Issue**: Build script creates `dist/` but doesn't copy or configure the `data/` directory with proper IIS permissions.

**Current Behavior**:

- `data/` directory not included in build output
- No automated permission setup for IIS_IUSRS

**Recommendation**:

1. Update [script/build.ts](script/build.ts#L100) to include data directory:

```typescript
// After building server
console.log("Setting up data directory...");
await mkdir("dist/data", { recursive: true });

// Copy initial data files for first-time setup
const dataFiles = ["users.json", "supporters.json", "quotes.json"];
for (const file of dataFiles) {
  try {
    await copyFile(`data/${file}`, `dist/data/${file}`);
  } catch {
    // Create empty if doesn't exist
    await writeFile(`dist/data/${file}`, JSON.stringify([]), "utf-8");
  }
}

// Create conversations directory structure
await mkdir("dist/data/conversations", { recursive: true });
await writeFile("dist/data/conversations/index.json", JSON.stringify([]), "utf-8");
await writeFile(
  "dist/data/conversations/meta.json",
  JSON.stringify({ lastConversationId: 0 }),
  "utf-8"
);
```

2. Update [script/deploy-iis.ps1](script/deploy-iis.ps1) (if exists) or create:

```powershell
# Set IIS_IUSRS permissions on data directory
$dataPath = Join-Path $deployPath "data"
Write-Host "Configuring IIS_IUSRS permissions on $dataPath..."

$acl = Get-Acl $dataPath
$permission = "IIS_IUSRS", "Modify", "ContainerInherit,ObjectInherit", "None", "Allow"
$accessRule = New-Object System.Security.AccessControl.FileSystemAccessRule $permission
$acl.SetAccessRule($accessRule)
Set-Acl $dataPath $acl

Write-Host "‚úì Data directory permissions configured"
```

3. Add deployment documentation to [docs/domain/deployment-iis.md](docs/domain/deployment-iis.md)

---

#### DEPLOY2: Production Database Not Configured (HIGH)

**Principle Violated**: VIII. Deployment & Hosting Standards

> "Production storage MUST use database (PostgreSQL) not file-based JSON"

**Location**: [server/storage.ts](server/storage.ts) - Entire file uses file-based JSON storage

**Issue**: File-based JSON storage is explicitly marked as "dev only" in constitution but no PostgreSQL implementation exists.

**Risk**:

- File corruption under concurrent access
- No transaction support
- Performance issues at scale
- No backup/recovery mechanisms

**Recommendation** (This Sprint):

1. Create PostgreSQL storage adapter:

```typescript
// server/storage-postgres.ts
import { Pool } from "pg";
import type { IStorage } from "./storage";

export class PostgresStorage implements IStorage {
  private pool: Pool;

  constructor() {
    this.pool = new Pool({
      connectionString: process.env.DATABASE_URL,
      ssl: process.env.NODE_ENV === "production" ? { rejectUnauthorized: false } : false,
    });
  }

  // Implement IStorage interface methods with PostgreSQL queries
}
```

2. Add database migration scripts in `db/migrations/`
3. Update [server/storage.ts](server/storage.ts#L570):

```typescript
// Export appropriate storage based on environment
export const storage = process.env.DATABASE_URL ? new PostgresStorage() : new FileStorage();
```

4. Install PostgreSQL client: `npm install pg @types/pg`

---

#### DEPLOY3: Environment Variable Documentation Incomplete (MEDIUM)

**Principle Violated**: VIII. Deployment & Hosting Standards

> "Environment variables MUST be configurable via .env file for local development and IIS Configuration Editor for production"

**Issue**: No comprehensive `.env.example` file documenting all required environment variables.

**Recommendation**:

Create `.env.example`:

```bash
# Session Configuration (REQUIRED)
SESSION_SECRET=generate_with_crypto_randomBytes_32

# Node Environment (REQUIRED)
NODE_ENV=production

# Database Configuration (REQUIRED for production)
DATABASE_URL=postgresql://user:password@localhost:5432/supportspark

# Optional: Override default port (IIS uses iisnode, so this is for local dev)
PORT=3000

# Optional: File storage directory (dev only)
DATA_DIR=./data
```

Add to [docs/domain/deployment-iis.md](docs/domain/deployment-iis.md):

````markdown
### Environment Variable Configuration for IIS

**Option 1: web.config (not recommended for secrets)**

```xml
<iisnode>
  <environmentVariables>
    <add name="NODE_ENV" value="production" />
    <add name="DATABASE_URL" value="postgresql://..." />
  </environmentVariables>
</iisnode>
```
````

**Option 2: IIS Configuration Editor (recommended)**

1. Open IIS Manager
2. Select your website
3. Configuration Editor ‚Üí system.webServer/iisnode
4. Edit `environmentVariables` collection
5. Add key-value pairs

````

---

#### DEPLOY4: Build Script Missing web.config Validation (MEDIUM)

**Location**: [script/build.ts](script/build.ts#L70-L75)

**Issue**: web.config is copied but not validated for correctness.

**Recommendation**:
```typescript
// After copying web.config
console.log("Validating web.config...");
const webConfig = await readFile("dist/web.config", "utf-8");
if (!webConfig.includes('<add name="iisnode"')) {
  throw new Error("web.config missing iisnode handler");
}
if (!webConfig.includes('path="index.cjs"')) {
  throw new Error("web.config references wrong entry point");
}
console.log("‚úì web.config validated");
````

---

## Package/Dependency Analysis

### Package Manager: npm

#### Dependency Summary

| Metric              | Value          |
| ------------------- | -------------- |
| Total Dependencies  | 60             |
| Direct Dependencies | 60             |
| Dev Dependencies    | 20             |
| Outdated            | 0 (per script) |
| Vulnerable          | 0 (per script) |
| Unused              | 0 (per script) |

**Status**: ‚úÖ HEALTHY

#### Security Dependencies Needed

Based on constitution violations, these packages should be added:

| Package                          | Purpose                            | Priority | Command                                           |
| -------------------------------- | ---------------------------------- | -------- | ------------------------------------------------- |
| bcrypt                           | Password hashing (Principle IV)    | CRITICAL | `npm install bcrypt`                              |
| @types/bcrypt                    | bcrypt TypeScript types            | CRITICAL | `npm install -D @types/bcrypt`                    |
| express-rate-limit               | Rate limiting (Principle IV)       | CRITICAL | `npm install express-rate-limit`                  |
| @types/express-rate-limit        | Rate limit TypeScript types        | CRITICAL | `npm install -D @types/express-rate-limit`        |
| pg                               | PostgreSQL client (Principle VIII) | HIGH     | `npm install pg`                                  |
| @types/pg                        | PostgreSQL TypeScript types        | HIGH     | `npm install -D @types/pg`                        |
| vitest                           | Test framework (Principle II)      | CRITICAL | `npm install -D vitest`                           |
| @vitest/ui                       | Vitest UI                          | HIGH     | `npm install -D @vitest/ui`                       |
| jsdom                            | Test environment                   | CRITICAL | `npm install -D jsdom`                            |
| @testing-library/react           | React testing utilities            | HIGH     | `npm install -D @testing-library/react`           |
| @testing-library/jest-dom        | DOM matchers                       | HIGH     | `npm install -D @testing-library/jest-dom`        |
| @testing-library/user-event      | User interaction testing           | HIGH     | `npm install -D @testing-library/user-event`      |
| supertest                        | API testing                        | HIGH     | `npm install -D supertest`                        |
| @types/supertest                 | Supertest TypeScript types         | HIGH     | `npm install -D @types/supertest`                 |
| eslint                           | Code linting (Principle VII)       | CRITICAL | `npm install -D eslint`                           |
| @typescript-eslint/parser        | TypeScript ESLint parser           | CRITICAL | `npm install -D @typescript-eslint/parser`        |
| @typescript-eslint/eslint-plugin | TypeScript rules                   | CRITICAL | `npm install -D @typescript-eslint/eslint-plugin` |
| eslint-plugin-react              | React rules                        | HIGH     | `npm install -D eslint-plugin-react`              |
| eslint-plugin-react-hooks        | React hooks rules                  | HIGH     | `npm install -D eslint-plugin-react-hooks`        |
| eslint-config-prettier           | ESLint-Prettier integration        | HIGH     | `npm install -D eslint-config-prettier`           |
| prettier                         | Code formatter                     | CRITICAL | `npm install -D prettier`                         |

**One-line install for all critical dependencies**:

```bash
npm install bcrypt express-rate-limit pg && npm install -D @types/bcrypt @types/express-rate-limit @types/pg vitest @vitest/ui jsdom @testing-library/react @testing-library/jest-dom @testing-library/user-event supertest @types/supertest eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin eslint-plugin-react eslint-plugin-react-hooks eslint-config-prettier prettier
```

---

## Code Quality Analysis

### Metrics Overview

| Metric                    | Value | Threshold | Status  |
| ------------------------- | ----- | --------- | ------- |
| Total Lines of Code       | 7,953 | -         | -       |
| Total Files               | 78    | -         | -       |
| Average Lines per File    | 102   | <300      | ‚úÖ PASS |
| Max Lines per File        | 673   | <500      | ‚ö†Ô∏è FAIL |
| TypeScript Files          | 77    | -         | ‚úÖ PASS |
| JavaScript Files          | 1     | -         | ‚úÖ PASS |
| High Complexity Functions | 0     | 0         | ‚úÖ PASS |
| Deep Nesting Occurrences  | 0     | 0         | ‚úÖ PASS |
| TODO Comments             | 0     | -         | ‚úÖ PASS |
| Test Coverage             | 0%    | >80%      | ‚ùå FAIL |

### Files Requiring Attention

| ID    | File                                                                         | Issue                     | Metric    | Recommendation                                         |
| ----- | ---------------------------------------------------------------------------- | ------------------------- | --------- | ------------------------------------------------------ |
| QUAL1 | [client/src/components/ui/sidebar.tsx](client/src/components/ui/sidebar.tsx) | Excessive length          | 673 lines | Split into smaller components or accept as vendor code |
| QUAL2 | [server/routes.ts](server/routes.ts)                                         | Multiple responsibilities | 511 lines | Extract route groups into separate modules             |
| QUAL3 | [server/storage.ts](server/storage.ts)                                       | Large implementation      | 587 lines | Extract demo data setup into separate file             |

### Code Organization Recommendations

#### QUAL1: Sidebar Component Length (LOW)

**File**: [client/src/components/ui/sidebar.tsx](client/src/components/ui/sidebar.tsx)
**Lines**: 673
**Status**: ‚ö†Ô∏è Acceptable (shadcn/ui vendor component)

**Rationale**: This is a vendored component from shadcn/ui. Constitution Principle III states components from `@/components/ui/` should not be edited directly.

**Recommendation**: Accept as-is. If customization needed, create wrapper component in `@/components/` directory.

---

#### QUAL2: Routes File Refactoring (MEDIUM)

**File**: [server/routes.ts](server/routes.ts)
**Lines**: 511
**Issue**: Single file contains all route handlers, middleware, and Passport configuration.

**Recommendation**: Split into modules:

```
server/
  routes/
    auth.ts          # Authentication routes & Passport setup
    conversations.ts # Conversation CRUD routes
    supporters.ts    # Supporter relationship routes
    demo.ts          # Demo account routes
    uploads.ts       # Image upload routes
    index.ts         # Route registration
  middleware/
    requireAuth.ts   # Auth middleware
    rateLimiter.ts   # Rate limiting middleware
```

**Benefits**:

- Easier to test individual route groups
- Better code organization
- Clearer separation of concerns

---

#### QUAL3: Storage Demo Data Extraction (MEDIUM)

**File**: [server/storage.ts](server/storage.ts)
**Lines**: 587 (with 300+ lines of demo data)
**Issue**: Demo conversation content embedded in storage logic.

**Recommendation**: Extract to separate file:

```typescript
// server/fixtures/demo-data.ts
export const DEMO_MEMBER_ID = "demo-member-sarah";
export const DEMO_SUPPORTER_ID = "demo-supporter-james";

export function getDemoMember() { ... }
export function getDemoSupporter() { ... }
export function getDemoConversations() { ... }

// server/storage.ts
import { DEMO_MEMBER_ID, DEMO_SUPPORTER_ID, getDemoMember, getDemoSupporter, getDemoConversations } from './fixtures/demo-data';
```

---

## Unused Code Analysis

### Detection Summary

**Status**: ‚úÖ MINIMAL UNUSED CODE

No significant unused code, imports, or dead files detected during audit.

### Potentially Unused Items

| Type   | Item                                   | Location                                 | Confidence | Notes                                          |
| ------ | -------------------------------------- | ---------------------------------------- | ---------- | ---------------------------------------------- |
| File   | [postcss.config.js](postcss.config.js) | Root                                     | LOW        | May be used by Tailwind build process          |
| Export | `InsertSupporter` type                 | [shared/schema.ts](shared/schema.ts#L77) | LOW        | Defined but comment suggests not actively used |

**Recommendation**: These are acceptable. Minimal cleanup needed.

---

## Duplicate Code Analysis

### Detection Summary

**Status**: ‚úÖ NO SIGNIFICANT DUPLICATION

No exact or near-duplicate code blocks detected exceeding minimum thresholds (>10 lines, >80% similarity).

### Minor Patterns

| Pattern                     | Occurrences       | Recommendation                                  |
| --------------------------- | ----------------- | ----------------------------------------------- |
| Error handling in mutations | Multiple hooks    | ACCEPTABLE - idiomatic React Query pattern      |
| Storage persistence methods | FileStorage class | ACCEPTABLE - each method has unique logic       |
| Demo data message structure | 2 conversations   | ACCEPTABLE - intentionally similar demo content |

**Recommendation**: No refactoring needed at this time.

---

## Recommendations

### Immediate Actions (CRITICAL) - Must Complete Before Production

1. **SEC1: Implement bcrypt password hashing**
   - Install bcrypt package
   - Update authentication logic in [server/routes.ts](server/routes.ts#L41-L49)
   - Migrate existing user passwords (requires user action)
   - Estimated effort: 2-3 hours

2. **SEC2: Remove hardcoded session secret fallback**
   - Update [server/routes.ts](server/routes.ts#L23) to throw error if SESSION_SECRET not set
   - Document environment variable setup in deployment guide
   - Estimated effort: 30 minutes

3. **SEC3: Implement rate limiting on auth endpoints**
   - Install express-rate-limit
   - Apply to login, register, and demo routes
   - Estimated effort: 1 hour

4. **TEST1: Set up Vitest infrastructure**
   - Create vitest.config.ts
   - Install testing dependencies
   - Create test setup files
   - Write first authentication integration test
   - Estimated effort: 4 hours

5. **STYLE1: Configure ESLint and Prettier**
   - Create .eslintrc.json and .prettierrc.json
   - Install linting dependencies
   - Run initial fix pass (`npm run lint:fix`)
   - Address remaining violations
   - Estimated effort: 2 hours

6. **TYPE1-TYPE12: Fix `any` type violations**
   - Create proper TypeScript types for Express routes
   - Update schema.ts to export Message type properly
   - Replace `z.custom<any>()` with proper schemas
   - Estimated effort: 3-4 hours

**Total Critical Work**: ~12-15 hours before production deployment

---

### High Priority (This Sprint)

7. **DEPLOY1: Configure data directory for IIS**
   - Update build script to include data directory
   - Create PowerShell script for IIS_IUSRS permissions
   - Test deployment process
   - Estimated effort: 2 hours

8. **DEPLOY2: Implement PostgreSQL storage adapter**
   - Create PostgresStorage class implementing IStorage
   - Write database migration scripts
   - Add environment variable configuration
   - Test migration from file storage
   - Estimated effort: 8-12 hours

9. **TEST2-TEST5: Write critical test suites**
   - Authentication flow tests
   - Storage layer tests
   - API contract validation tests
   - React hook tests (use-auth, use-conversations)
   - Estimated effort: 12-16 hours

10. **QUAL2: Refactor routes.ts into modules**
    - Create routes/ directory structure
    - Split route handlers by domain
    - Extract middleware
    - Estimated effort: 4-6 hours

---

### Medium Priority (Next Sprint)

11. **SEC4: Enhance file upload security**
    - Add explicit filename sanitization
    - Implement virus scanning (if required)
    - Add file metadata validation
    - Estimated effort: 2-3 hours

12. **SEC5: Add comprehensive input validation**
    - Review all API endpoints for missing validation
    - Add Zod schemas for query parameters
    - Validate content length limits
    - Estimated effort: 3-4 hours

13. **DEPLOY3: Complete environment variable documentation**
    - Create .env.example file
    - Update deployment documentation
    - Add validation script for required env vars
    - Estimated effort: 1-2 hours

14. **DEPLOY4: Add web.config validation to build**
    - Implement build-time validation
    - Add automated tests for web.config structure
    - Estimated effort: 1 hour

15. **QUAL3: Extract demo data from storage.ts**
    - Create fixtures/demo-data.ts
    - Move demo content
    - Simplify storage.ts initialization
    - Estimated effort: 2 hours

---

### Low Priority (Backlog)

16. **QUAL1: Review sidebar.tsx component** (informational only)
17. **Create pre-commit hooks with Husky**
18. **Add TypeScript path validation script**
19. **Implement health check endpoint for IIS monitoring**
20. **Add structured logging for production troubleshooting**

---

## Comparative Analysis

**Status**: First audit - no historical data available.

Future audits will track progress on:

- Critical issue count (target: 0)
- Test coverage percentage (target: >80%)
- Type safety violations (target: <5 with justification)
- Constitution compliance score (target: >90%)

---

## Next Steps

### Before Merging Any New Code

1. ‚úÖ Review this audit report with team
2. ‚úÖ Prioritize critical issues for immediate sprint
3. ‚úÖ Create GitHub issues for each violation (use IDs: SEC1, TYPE1, etc.)
4. ‚úÖ Update project board with audit findings

### Before Production Deployment

1. ‚ùå **BLOCKER**: Implement bcrypt password hashing (SEC1)
2. ‚ùå **BLOCKER**: Remove hardcoded secrets (SEC2)
3. ‚ùå **BLOCKER**: Implement rate limiting (SEC3)
4. ‚ùå **BLOCKER**: Configure ESLint/Prettier (STYLE1)
5. ‚ùå **BLOCKER**: Fix all `any` type violations (TYPE1-TYPE12)
6. ‚ùå **BLOCKER**: Set up test infrastructure and write auth tests (TEST1)
7. ‚ö†Ô∏è **RECOMMENDED**: Implement PostgreSQL storage (DEPLOY2)
8. ‚ö†Ô∏è **RECOMMENDED**: Configure IIS data permissions (DEPLOY1)

### Ongoing Practices

- Run `/speckit.site-audit` weekly during active development
- Track compliance score trends
- Review new violations in PR reviews
- Update constitution as architecture evolves

---

## IIS Deployment Quick Reference

### Pre-Deployment Checklist for Windows 11 + IIS

‚úÖ = Ready | ‚ö†Ô∏è = Needs attention | ‚ùå = Blocking issue

- ‚úÖ web.config file present and configured
- ‚úÖ Build outputs CommonJS format (index.cjs)
- ‚úÖ Static files organized in dist/public/
- ‚úÖ URL rewrite rules for SPA routing
- ‚ö†Ô∏è Environment variables documented (DEPLOY3)
- ‚ùå Data directory permissions automation (DEPLOY1)
- ‚ùå Production database configured (DEPLOY2)
- ‚ùå SESSION_SECRET fallback removed (SEC2)
- ‚ö†Ô∏è SSL/TLS configuration (IIS level, not in code)

### Required IIS Components

Ensure these are installed on Windows 11 server:

1. **IIS 10.0+** - Windows Feature
2. **iisnode** - [Download](https://github.com/Azure/iisnode)
3. **URL Rewrite module** - [Download](https://www.iis.net/downloads/microsoft/url-rewrite)
4. **Node.js LTS** - [Download](https://nodejs.org/)

### Deployment Steps Summary

```powershell
# 1. Build application
npm run build

# 2. Copy dist/ to IIS website root
Copy-Item -Recurse -Force dist/* C:\inetpub\wwwroot\supportspark\

# 3. Install production dependencies
cd C:\inetpub\wwwroot\supportspark
npm install --production

# 4. Configure data directory permissions
$acl = Get-Acl "C:\inetpub\wwwroot\supportspark\data"
$permission = "IIS_IUSRS","Modify","ContainerInherit,ObjectInherit","None","Allow"
$rule = New-Object System.Security.AccessControl.FileSystemAccessRule $permission
$acl.SetAccessRule($rule)
Set-Acl "C:\inetpub\wwwroot\supportspark\data" $acl

# 5. Set environment variables in IIS Configuration Editor
# (Open IIS Manager ‚Üí Select site ‚Üí Configuration Editor ‚Üí system.webServer/iisnode)

# 6. Test deployment
Start-Process "http://localhost/supportspark"
```

### Environment Variables for Production

Set in IIS Configuration Editor:

```
NODE_ENV=production
SESSION_SECRET=<generate-with-crypto-randomBytes-32>
DATABASE_URL=postgresql://user:password@localhost:5432/supportspark
```

---

_Audit generated by speckit.site-audit v1.0_  
_Constitution-driven codebase audit for SupportSpark_  
_Constitution version: 1.1.0 | Ratified: 2026-02-01_

**Next audit recommended**: 2026-02-08 (7 days)

**To re-run audit**:

```bash
/speckit.site-audit
/speckit.site-audit --scope=constitution
/speckit.site-audit --scope=security
```

**Review constitution**: [.specify/memory/constitution.md](.specify/memory/constitution.md)  
**Deployment guide**: [docs/domain/deployment-iis.md](docs/domain/deployment-iis.md)  
**Architecture overview**: [docs/domain/architecture.md](docs/domain/architecture.md)

---

## Appendix: File Inventory

### Source Code Distribution

| Extension | Files | Lines | Percentage |
| --------- | ----- | ----- | ---------- |
| .tsx      | 61    | 6,186 | 77.8%      |
| .ts       | 16    | 1,761 | 22.1%      |
| .js       | 1     | 6     | 0.1%       |

### File Categories

- **UI Components**: 44 files (shadcn/ui primitives + custom)
- **React Hooks**: 5 files
- **React Pages**: 7 files
- **Server**: 5 files
- **Shared**: 2 files
- **Scripts**: 8 files
- **Configuration**: 13 files
- **Documentation**: 42 files

### Constitution-Governed Pathways

Per Principle VIII project structure:

- ‚úÖ `client/src/components/ui/` - shadcn/ui primitives (61 files)
- ‚úÖ `client/src/components/` - Custom components (3 files)
- ‚úÖ `client/src/hooks/` - Custom hooks (5 files, naming convention followed)
- ‚úÖ `client/src/pages/` - Route components (7 files)
- ‚úÖ `client/src/lib/` - Utilities (3 files)
- ‚úÖ `server/` - Express backend (5 files)
- ‚úÖ `shared/` - Shared contracts (2 files)
- ‚úÖ `data/` - File storage (development only, awaiting PostgreSQL migration)

---

**END OF AUDIT REPORT**
